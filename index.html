<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LIFF Demo - v12 (Corrected)</title>
    <style>
        body { font-family: sans-serif; max-width: 820px; margin: auto; padding: 1.5rem; background: #fff; line-height: 1.6; }
        .box { padding: 1rem; border: 1px solid #ccc; border-radius: .6rem; margin-top: 1rem; background: #f9f9f9; }
        .ok { background: #dff0d8; border-color: #bfe7b9; }
        .ng { background: #f2dede; border-color: #e3c4c4; }
        code { white-space: pre-wrap; word-break: break-all; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
    </style>
</head>
<body>
    <h1>LIFF Demo - 修正版 (v12)</h1>
    <p>遷移前の元URL: <code id="urlBefore"></code></p>
    
    <h2>抽出された redirect_uri データ</h2>
    <div id="resultData" class="box">(データなし)</div>

    <h2>LIFF 初期化ステータス</h2>
    <div id="status" class="box">初期化処理を開始します...</div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        (async () => {
            // --- 定数とDOM要素の準備 ---
            const LIFF_ID = '2007624426-93P1xyXj';
            const resultEl = document.getElementById('resultData');
            const statusEl = document.getElementById('status');
            const urlBeforeEl = document.getElementById('urlBefore');
            
            // ページ読み込み時のURLを記録
            const initialUrl = window.location.href;
            urlBeforeEl.textContent = initialUrl;

            // --- メイン処理 ---
            try {
                // 1. URLからデータを抽出し、sessionStorageに保存
                //    この処理は liff.init の前でも後でも問題ありません。
                const url = new URL(initialUrl);
                let redirectUriValue = null;
                if (url.hash) {
                    redirectUriValue = new URLSearchParams(url.hash.slice(1)).get('redirect_uri');
                }
                if (!redirectUriValue) {
                    redirectUriValue = url.searchParams.get('redirect_uri');
                }
                if (redirectUriValue) {
                    sessionStorage.setItem('paypayResult', redirectUriValue);
                }

                // 2. liff.init()の実行
                //    URLのクリーニングは不要です。liff.initが内部で適切に処理します。
                //    認証が必要な場合は、このawaitの間に自動でログイン画面へ遷移し、戻ってきます。
                statusEl.textContent = 'liff.init() を実行中...';
                await liff.init({ liffId: LIFF_ID });

                // 3. ログイン状態の確認と最終処理
                if (liff.isLoggedIn()) {
                    statusEl.textContent = 'liff.init() & ログイン成功！';
                    statusEl.classList.add('ok');

                    // sessionStorageからデータを読み込んで表示
                    const finalData = sessionStorage.getItem('paypayResult');
                    if (finalData) {
                        resultEl.textContent = decodeURIComponent(finalData);
                    } else {
                        resultEl.textContent = '(sessionStorageにデータがありません)';
                    }
                } else {
                    // ユーザーがログイン画面でキャンセルした場合など
                    statusEl.textContent = '未ログイン状態です。認可されなかったか、ログインがキャンセルされました。';
                    statusEl.classList.add('ng');
                }

            } catch (error) {
                // liff.init()自体が失敗した場合 (設定ミスなど)
                statusEl.textContent = 'liff.init() で致命的なエラーが発生しました。\n\n' + JSON.stringify(error, null, 2);
                statusEl.classList.add('ng');
                console.error('LIFF Initialization failed:', error);
            }
        })();
    </script>
</body>
</html>
