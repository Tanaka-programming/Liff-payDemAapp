<!-- ============================================================================================== -->
<!-- ② LIFF-DEMO.HTML                                                                                -->
<!-- ============================================================================================== -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LIFF Demo – URL 差分 & 400 解消</title>
  <style>
    body{font-family:sans-serif;padding:1.5rem;max-width:820px;margin:auto;background:#fff;line-height:1.6;}
    .box{padding:1rem;border:1px solid #ccc;border-radius:.6rem;margin-top:1rem;background:#f9f9f9;}
    .ok{background:#dff0d8;border-color:#c7e4bf;}
    .ng{background:#f2dede;border-color:#e2c1c1;}
    code{word-break:break-all;white-space:pre-wrap;}
  </style>
</head>
<body>
  <h1>LIFF Demo – init 前後の URL を比較</h1>
  <p>起動直後 URL: <code id="urlBefore"></code></p>
  <p>init 完了後 URL: <code id="urlAfter"></code></p>

  <h2>受け取った redirect_uri</h2>
  <div id="raw" class="box">(none)</div>
  <div id="decoded" class="box">(none)</div>

  <h2>LIFF 初期化ステータス</h2>
  <div id="status" class="box">init 中…</div>

  <!-- LIFF SDK 読み込み -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    (async () => {
      const LIFF_ID             = "2007624426-93P1xyXj"; // ← あなたの LIFF ID
      const DEV_REGISTERED_URL  = `https://liff.line.me/${LIFF_ID}`; // DevConsole に登録した“素”URL

      /* --- DOM 取得 --- */
      const urlBeforeEl = document.getElementById('urlBefore');
      const urlAfterEl  = document.getElementById('urlAfter');
      const rawEl       = document.getElementById('raw');
      const decEl       = document.getElementById('decoded');
      const stEl        = document.getElementById('status');

      urlBeforeEl.textContent = location.href;  // 起動直後の URL を保存

      /* -------------------------------------------------------------------
         1. PayPay から受け取ったパラメータを抽出 (hash優先)             
         2. 必要なら sessionStorage に退避                              
         3. redirect_uri 源となる fragment / query を URL から除去         
      ------------------------------------------------------------------- */
      const urlObj = new URL(location.href);
      let paypayData = null;

      // hash (#redirect_uri=) の場合
      if(urlObj.hash){
        const hashParams = new URLSearchParams(urlObj.hash.substring(1));
        paypayData = hashParams.get('redirect_uri');
        if(paypayData) sessionStorage.setItem('paypayResult', paypayData);
        history.replaceState(null,'', DEV_REGISTERED_URL + urlObj.search); // hash 部分を削る
      }else{
        // query (?redirect_uri=) の場合
        paypayData = urlObj.searchParams.get('redirect_uri');
        if(paypayData){
          sessionStorage.setItem('paypayResult', paypayData);
          urlObj.searchParams.delete('redirect_uri');
          history.replaceState(null,'', DEV_REGISTERED_URL); // query を削る
        }
      }

      /* 表示用デコード */
      if(paypayData){
        rawEl.textContent = paypayData;
        decEl.innerHTML = `<b>1回 decode:</b> ${decodeURIComponent(paypayData)}<br>`+
                          `<b>2回 decode:</b> ${decodeURIComponent(decodeURIComponent(paypayData))}`;
      }

      /* -------------------------------------------------------------------
         4. LIFF init
            - withLoginOnExternalBrowser:true でも redirect_uri を常に DEV_REGISTERED_URL に固定
            - 未ログインなら liff.login() で外部ブラウザへ (redirectUri も固定)
      ------------------------------------------------------------------- */
      try{
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

        if(!liff.isLoggedIn()){
          liff.login({ redirectUri: DEV_REGISTERED_URL });
          return; // ブラウザへ遷移するのでこれ以降は実行されない
        }

        // init 成功表示
        stEl.textContent = 'liff.init() 成功 – ログイン済';
        stEl.classList.add('ok');
      }catch(err){
        stEl.textContent = `liff.init() 失敗 → ${err}`;
        stEl.classList.add('ng');
        console.error(err);
      }

      /* 5. init 後の最終 URL を表示 (ここが登録 URL と一致しているはず) */
      urlAfterEl.textContent = location.href;

      /* 6. PayPay 結果を API へ送る例 (ダミー) */
      /*
      const resultPath = sessionStorage.getItem('paypayResult');
      if(resultPath){
        await fetch('/api/paypay/confirm', { method:'POST', body: resultPath });
      }
      */
    })();
  </script>
</body>
</html>
