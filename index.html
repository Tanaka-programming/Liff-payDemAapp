<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Endpoint</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .box { padding: 1rem; border-radius: .6rem; margin-top: 1rem; background: #f0f0f0; }
        .primary { border: 2px solid #31708f; }
        .secondary { border: 2px solid #3c763d; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        code { white-space: pre-wrap; word-break: break-all; background: #fff; padding: 2px 4px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>LIFFリダイレクト先ページ</h1>

    <div id="redirectStage"></div>
    <div id="urlDisplay" class="box"></div>
    <div id="paramDisplay" class="box"></div>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- ★★★ ここにLIFF IDを設定 ★★★ ---
        const MY_LIFF_ID = "2007624426-93P1xyXj";
        // ------------------------------------

        // このページのメインロジック
        (async () => {
            const stageDiv = document.getElementById('redirectStage');
            const urlDiv = document.getElementById('urlDisplay');
            const paramDiv = document.getElementById('paramDisplay');

            const currentUrl = window.location.href;
            const params = new URLSearchParams(window.location.search);

            // liff.stateの有無で、1次リダイレクト先か2次リダイレクト先かを判定
            if (params.has('liff.state')) {
                // --- 1次リダイレクト先の処理 ---
                stageDiv.innerHTML = "<h2>現在地: 1次リダイレクト先</h2><p>liff.stateパラメータが存在するため、1次リダイレクト先と判断しました。これからliff.init()を実行し、2次リダイレクトをトリガーします。</p>";
                urlDiv.classList.add('primary');
                urlDiv.innerHTML = "<h3>現在のURL</h3><code>" + currentUrl + "</code>";
                paramDiv.innerHTML = "<h3>liff.state の中身</h3><code>" + params.get('liff.state') + "</code>";

                try {
                    await liff.init({ liffId: MY_LIFF_ID });
                } catch (e) {
                    console.error(e);
                    stageDiv.innerHTML += "<p style='color:red;'>liff.init()でエラーが発生しました。</p>";
                }

            } else {
                // --- 2次リダイレクト先の処理 ---
                stageDiv.innerHTML = "<h2>現在地: 2次リダイレクト先（最終ページ）</h2><p>liff.stateパラメータが存在しないため、2次リダイレクト先と判断しました。URLパラメータがどのようにデコードされたかを確認してください。</p>";
                urlDiv.classList.add('secondary');
                urlDiv.innerHTML = "<h3>現在のURL</h3><code>" + currentUrl + "</code>";

                // パラメータを取得して表示
                const callbackParam = params.get('callback');
                paramDiv.innerHTML = "<h3>'callback'パラメータの値</h3>" +
                                     "<p>LIFF SDKによる再構築の結果、以下の値が取得されました。</p>" +
                                     "<code>" + callbackParam + "</code>" +
                                     "<p style='margin-top:1em; font-weight:bold; color:red;'>注意：もし元の値が 'https%3A%2F%2F...' であった場合、この時点で 'https://...' のようにデコードされてしまっているため、URLの構造が壊れています。</p>";
                
                try {
                    await liff.init({ liffId: MY_LIFF_ID });
                } catch (e) {
                    console.error(e);
                    stageDiv.innerHTML += "<p style='color:red;'>liff.init()でエラーが発生しました。</p>";
                }
            }
        })();
    </script>
</body>
</html>
