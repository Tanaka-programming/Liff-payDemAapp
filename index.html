<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Fragment Verifier - Endpoint</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; word-break: break-all; }
        th { background-color: #f2f2f2; width: 150px; }
        code { white-space: pre-wrap; background: #e8e8e8; padding: 2px 4px; border-radius: 4px; }
        .notice { background-color: #dff0d8; border: 1px solid #bfe7b9; color: #3c763d; padding: 15px; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>フラグメント方式 動作検証結果</h1>

    <div id="report">
        <p>初期化処理中...</p>
    </div>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const MY_LIFF_ID = "2007624426-93P1xyXj";

        (async () => {
            const reportDiv = document.getElementById('report');

            try {
                // まずはliff.init()を実行
                await liff.init({ liffId: MY_LIFF_ID });

                // sessionStorageから全情報を取得してレポートを作成
                const url1 = sessionStorage.getItem('url_1_initial_fragment_test') || '(情報なし)';
                const url2_final = window.location.href; // このページのURLが最終URL

                // フラグメントを解析
                const hash = window.location.hash.substring(1);
                const finalParams = new URLSearchParams(hash);
                const finalPath = finalParams.get('path') || 'null (取得失敗)';
                const finalCallback = finalParams.get('callback') || 'null (取得失敗)';

                reportDiv.innerHTML = `
                    <h2>リダイレクト結果レポート</h2>
                    <table>
                        <tr><th>段階</th><th>URL / 値</th></tr>
                        <tr><td><b>URL① (入力)</b><br>最初にアクセスしたLIFF URL</td><td><code>${url1}</code></td></tr>
                        <tr><td><b>URL② (出力)</b><br>最終的に表示されたページのURL</td><td><code>${url2_final}</code></td></tr>
                    </table>
                    <h2 style="margin-top:2em;">最終ページでのデータ取得結果</h2>
                    <table>
                        <tr><th>キー</th><th>取得・デコードされた値</th></tr>
                        <tr><td><b>path</b></td><td style="color:blue; font-weight:bold;"><code>${finalPath}</code></td></tr>
                        <tr><td><b>callback</b></td><td style="color:blue; font-weight:bold;"><code>${finalCallback}</code></td></tr>
                    </table>
                    <div class="notice">
                        <h3>分析結果</h3>
                        <p>URL①でフラグメントに含めたデータが、LIFFプラットフォームによる加工を一切受けずに、最終的なURL②にそのまま保持されていることが確認できます。</p>
                        <p>また、その値をJavaScriptで正常にデコード（復元）できています。これにより、フラグメント方式が安全かつ確実な解決策であることが証明されます。</p>
                    </div>
                `;
            } catch (e) {
                reportDiv.innerHTML = "<h2>エラー</h2><p>liff.init()が失敗しました。LIFFの基本設定（エンドポイントURL、公開ステータスなど）をご確認ください。</p><code>" + JSON.stringify(e) + "</code>";
            }
        })();
    </script>
</body>
</html>
