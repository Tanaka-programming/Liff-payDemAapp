<!-- ============================================================= -->
<!--  ② LIFF‑DEMO.HTML                                            -->
<!-- ============================================================= -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LIFF Demo (EX予約検証)</title>
  <style>
    body{font-family:sans-serif;padding:1.5rem;line-height:1.6;background:#fff;max-width:760px;margin:auto;}
    .box{padding:1rem;border:1px solid #ccc;border-radius:.5rem;margin-top:1rem;background:#f9f9f9;}
    .ok{background:#dff0d8;border-color:#d6e9c6;}
    .ng{background:#f2dede;border-color:#ebccd1;}
    code{word-break:break-all;white-space:pre-wrap;}
  </style>
</head>
<body>
  <h1>LIFF Demo ‑ 二重エンコード検証</h1>
  <p>現在 URL: <code id="url"></code></p>

  <h2>受け取った redirect_uri</h2>
  <div id="raw" class="box">(none)</div>
  <div id="decoded" class="box">(none)</div>

  <h2>LIFF 初期化</h2>
  <div id="status" class="box">init 中…</div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    (async()=>{
      const LIFF_ID = "2007624426-93P1xyXj"; // 固定値
      const urlEl = document.getElementById('url');
      const rawEl = document.getElementById('raw');
      const decEl = document.getElementById('decoded');
      const stEl  = document.getElementById('status');
      urlEl.textContent=location.href;

      // redirect_uri 抽出
      let val=null;
      if(location.hash){
        const h=new URLSearchParams(location.hash.substr(1));
        val=h.get('redirect_uri');
        history.replaceState(null,'',location.pathname+location.search);
      }else if(location.search){
        val=new URLSearchParams(location.search).get('redirect_uri');
      }
      if(val){
        rawEl.textContent=val;
        const once=decodeURIComponent(val);
        const twice=decodeURIComponent(once);
        decEl.innerHTML=`<b>1回 decode:</b> ${once}<br><b>2回 decode:</b> ${twice}`;
      }else rawEl.textContent='(redirect_uri なし)';

      // LIFF init
      try{
        await liff.init({liffId:LIFF_ID,withLoginOnExternalBrowser:true});
        if(!liff.isLoggedIn()){liff.login({redirectUri:location.href});return;}
        stEl.textContent='liff.init() 成功';stEl.classList.add('ok');
      }catch(e){
        stEl.textContent='liff.init() 失敗 → '+e;stEl.classList.add('ng');console.error(e);
      }
    })();
  </script>
</body>
</html>
