<!-- ============================================================================================== -->
<!-- ② LIFF‑DEMO.HTML                                                                                 -->
<!-- ============================================================================================== -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LIFF Demo (EX予約検証)</title>
  <style>
    body{font-family:sans-serif;padding:1.5rem;line-height:1.6;background:#fff;max-width:780px;margin:auto;}
    .box{padding:1rem;border:1px solid #ccc;border-radius:.5rem;margin-top:1rem;background:#f9f9f9;}
    .ok{background:#dff0d8;border-color:#d6e9c6;}
    .ng{background:#f2dede;border-color:#ebccd1;}
    code{word-break:break-all;white-space:pre-wrap;}
  </style>
</head>
<body>
  <h1>LIFF Demo – init 前後の URL と redirect_uri を確認</h1>
  <p>起動直後 URL: <code id="urlBefore"></code></p>
  <p>init 完了後 URL: <code id="urlAfter"></code></p>

  <h2>受け取った redirect_uri</h2>
  <div id="raw" class="box">(none)</div>
  <div id="decoded" class="box">(none)</div>

  <h2>LIFF 初期化ステータス</h2>
  <div id="status" class="box">init 中…</div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    (async()=>{
      /*
        ▼ 1. DOM 参照をまとめて取得
      */
      const urlBeforeEl = document.getElementById('urlBefore');
      const urlAfterEl  = document.getElementById('urlAfter');
      const rawEl       = document.getElementById('raw');
      const decEl       = document.getElementById('decoded');
      const stEl        = document.getElementById('status');

      /*
        ▼ 2. 起動直後の URL を表示
           history.replaceState() 前に記録しておく
      */
      urlBeforeEl.textContent = location.href;

      /*
        ▼ 3. redirect_uri の抽出
           - #fragment 優先で取得
           - 取得後 fragment を URL から除外して LIFF と衝突させない
      */
      let redirectVal = null;
      if(location.hash){
        const hashParams = new URLSearchParams(location.hash.substring(1));
        redirectVal = hashParams.get('redirect_uri');
        // fragment を削除して二重エンコード源を絶つ
        history.replaceState(null, '', location.pathname + location.search);
      }else if(location.search){
        redirectVal = new URLSearchParams(location.search).get('redirect_uri');
      }

      /*
        ▼ 4. 抽出した redirect_uri をそのまま / 1回 decode / 2回 decode の3パターンで表示
      */
      if(redirectVal){
        rawEl.textContent = redirectVal;
        const once  = decodeURIComponent(redirectVal);
        const twice = decodeURIComponent(once);
        decEl.innerHTML = `<b>1回 decode:</b> ${once}<br><b>2回 decode:</b> ${twice}`;
      }

      /*
        ▼ 5. LIFF 初期化
           withLoginOnExternalBrowser:true → 外部ブラウザで認可フローを強制
           liff.login() の再帰呼び出しで未ログイン時にリダイレクト
      */
      try{
        await liff.init({
          liffId: "2007624426-93P1xyXj",
          withLoginOnExternalBrowser: true
        });

        if(!liff.isLoggedIn()){
          // 未ログインなら外部ブラウザのログイン画面へ誘導
          liff.login({ redirectUri: location.href });
          return; // この後のコードはログイン後に再実行される
        }

        stEl.textContent = 'liff.init() 成功';
        stEl.classList.add('ok');
      }catch(err){
        stEl.textContent = `liff.init() 失敗 → ${err}`;
        stEl.classList.add('ng');
        console.error(err);
      }

      /*
        ▼ 6. init 完了時点 (または失敗時点) の最終 URL を表示
           ここで %252F → %2F などに変化しているかチェック可能
      */
      urlAfterEl.textContent = location.href;
    })();
  </script>
</body>
</html>
