<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LIFF Demo - v14 (External Browser Login)</title>
    <style>
        body { font-family: sans-serif; max-width: 820px; margin: auto; padding: 1.5rem; background: #fff; line-height: 1.6; }
        .box { padding: 1rem; border: 1px solid #ccc; border-radius: .6rem; margin-top: 1rem; background: #f9f9f9; }
        .ok { background: #dff0d8; border-color: #bfe7b9; color: #3c763d; }
        .ng { background: #f2dede; border-color: #e3c4c4; color: #a94442; }
        .info { background-color: #d9edf7; color: #31708f; border: 1px solid #bce8f1; }
        code { white-space: pre-wrap; word-break: break-all; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
    </style>
</head>
<body>
    <h1>LIFF Demo - 外部ブラウザでのみログイン (v14)</h1>
    <p>現在のURL: <code id="currentUrl"></code></p>
    
    <h2>抽出された redirect_uri データ</h2>
    <div id="resultData" class="box">(データなし)</div>

    <h2>LIFF 初期化ステータス</h2>
    <div id="status" class="box">初期化処理を開始します...</div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        (async () => {
            // --- 定数とDOM要素の準備 ---
            const LIFF_ID = '2007624426-93P1xyXj'; // ご自身のLIFF ID
            const resultEl = document.getElementById('resultData');
            const statusEl = document.getElementById('status');
            const urlEl = document.getElementById('currentUrl');
            
            urlEl.textContent = window.location.href;

            // --- メイン処理 ---
            try {
                // 1. URLからデータを抽出し、sessionStorageに保存
                const url = new URL(window.location.href);
                let redirectUriValue = null;
                if (url.hash && url.hash.includes('redirect_uri')) {
                    redirectUriValue = new URLSearchParams(url.hash.slice(1)).get('redirect_uri');
                } else if (url.searchParams.has('redirect_uri')) {
                    redirectUriValue = url.searchParams.get('redirect_uri');
                }
                if (redirectUriValue) {
                    sessionStorage.setItem('paypayResult', redirectUriValue);
                }

                // 2. liff.init()の実行
                statusEl.textContent = 'liff.init() を実行中...';
                await liff.init({ liffId: LIFF_ID });
                statusEl.textContent = 'liff.init() 成功！';
                statusEl.classList.add('ok');

                // 3. 【ここが重要】外部ブラウザ、かつ、未ログインの場合のみ liff.login() を実行
                if (!liff.isInClient() && !liff.isLoggedIn()) {
                    statusEl.textContent += '\n外部ブラウザかつ未ログインのため、ログインページに遷移します...';
                    // liff.login() を呼び出すと、ページがリダイレクトされるため、ここで処理は中断される
                    liff.login();
                    return; // 念のため処理を中断
                }

                // 4. 最終的な成功処理
                // (LINE内ブラウザの場合、または外部ブラウザで既にログイン済みの場合にこの処理が実行される)
                const finalData = sessionStorage.getItem('paypayResult');
                if (finalData) {
                    resultEl.textContent = decodeURIComponent(finalData);
                } else {
                    resultEl.textContent = '(sessionStorageにデータがありません)';
                }

            } catch (error) {
                // liff.init()自体が失敗した場合
                statusEl.innerHTML = 'liff.init() で致命的なエラーが発生しました。<br><br>' +
                                   '<b>エラー:</b> ' + JSON.stringify(error, null, 2) + '<br><br>' +
                                   '<b>【確認事項】</b><br>' +
                                   'LIFFの基本設定（エンドポイントURL、公開ステータス）が正しいかご確認ください。';
                statusEl.classList.add('ng');
                console.error('LIFF Initialization failed:', error);
            }
        })();
    </script>
</body>
</html>
